{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>üîÆ AI Price Forecast</h2>
        <p class="text-muted">Generate intelligent price predictions for optimal selling decisions</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üìã Farm Details</h5>
                <form method="POST">
                    <div class="mb-3">
                        <label for="harvest_date" class="form-label">üìÖ Harvest Date</label>
                        <input type="date" class="form-control" id="harvest_date" name="harvest_date" 
                               value="{{ form_values.harvest_date }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">üì¶ Quantity (kg)</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               value="{{ form_values.quantity }}" min="1" max="10000" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="storage_quality" class="form-label">üè™ Storage Quality</label>
                        <select class="form-select" id="storage_quality" name="storage_quality">
                            <option value="Excellent (Air-tight, Cool)" {% if form_values.storage_quality == "Excellent (Air-tight, Cool)" %}selected{% endif %}>Excellent (Air-tight, Cool)</option>
                            <option value="Good (Covered, Dry)" {% if form_values.storage_quality == "Good (Covered, Dry)" %}selected{% endif %}>Good (Covered, Dry)</option>
                            <option value="Average (Basic Storage)" {% if form_values.storage_quality == "Average (Basic Storage)" %}selected{% endif %}>Average (Basic Storage)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="forecast_from_date" class="form-label">üîÆ Forecast From Date</label>
                        <input type="date" class="form-control" id="forecast_from_date" name="forecast_from_date" 
                               value="{{ form_values.forecast_from_date }}" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">üîÑ Generate Forecast</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        {% if forecast_data %}
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">üìà 30-Day Price Forecast</h5>
                <div id="forecast-chart"></div>
            </div>
        </div>
        {% endif %}
        
        {% if recommendation %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üéØ AI Recommendation</h5>
                
                {% if recommendation.action == 'HOLD' %}
                <div class="alert alert-warning">
                    <h5><i class="fas fa-hand-paper"></i> HOLD Your Cardamom</h5>
                    <p><strong>Reason:</strong> {{ recommendation.reason }}</p>
                    <p><strong>Wait:</strong> {{ recommendation.days_to_wait }} days</p>
                    <p><strong>Optimal Date:</strong> 
                        {% if recommendation.optimal_sell_date %}
                            {% set date_obj = recommendation.optimal_sell_date %}
                            {% if date_obj is string %}
                                {{ date_obj }}
                            {% else %}
                                {{ date_obj.strftime('%d %B %Y') }}
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <h5><i class="fas fa-money-bill-wave"></i> SELL Now!</h5>
                    <p><strong>Reason:</strong> {{ recommendation.reason }}</p>
                </div>
                {% endif %}
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>üìä Price Metrics</h6>
                        <p><strong>Current Price:</strong> ‚Çπ{{ "%.0f"|format(recommendation.current_price_estimate) }}/kg</p>
                        <p><strong>Optimal Price:</strong> ‚Çπ{{ "%.0f"|format(recommendation.optimal_price_estimate) }}/kg</p>
                    </div>
                    <div class="col-md-6">
                        <h6>üí∞ Potential Earnings</h6>
                        <p><strong>Gain per kg:</strong> ‚Çπ{{ "%.0f"|format(recommendation.potential_gain_rs_per_kg) }}</p>
                        <p><strong>Total Potential:</strong> ‚Çπ{{ "%.0f"|format(recommendation.potential_gain_rs_per_kg * quantity) }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Optional: localStorage for browser-level persistence -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Restore from localStorage on page load
    ['harvest_date', 'quantity', 'storage_quality', 'forecast_from_date'].forEach(function(id) {
        let savedValue = localStorage.getItem('spicehold_' + id);
        let element = document.getElementById(id);
        if (savedValue && element && !element.value) {
            element.value = savedValue;
        }
    });
    
    // Save to localStorage when values change
    ['harvest_date', 'quantity', 'storage_quality', 'forecast_from_date'].forEach(function(id) {
        let element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                localStorage.setItem('spicehold_' + id, this.value);
            });
        }
    });
});
</script>

{% endblock %}

{% block scripts %}
{% if forecast_data %}
<script>
    const forecastData = {{ forecast_data|safe }};
    
    const trace = {
        x: forecastData.labels,
        y: forecastData.prices,
        type: 'scatter',
        mode: 'lines+markers',
        line: {color: '#007bff', width: 3},
        marker: {size: 5}
    };
    
    const layout = {
        title: 'Cardamom Price Forecast',
        xaxis: {
            title: 'Date',
            tickangle: 45,        // Rotate labels
            automargin: true      // Auto-adjust margins
        },
        yaxis: {title: 'Price (‚Çπ/kg)'},
        margin: {l: 50, r: 30, t: 60, b: 100},  // Increase bottom margin
        height: 450
    };
    
    Plotly.newPlot('forecast-chart', [trace], layout, {responsive: true});
</script>
{% endif %}
{% endblock %}